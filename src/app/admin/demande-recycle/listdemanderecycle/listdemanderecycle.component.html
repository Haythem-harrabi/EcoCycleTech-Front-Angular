

<div class="container mt-4">
    <!-- Add Button -->
    <button class="btn btn-primary mb-3" (click)="resetForm(); openModal()">Ajouter une demande</button>
  
    <!-- Search --> 
    <div class="mb-3">
      <input type="text" class="form-control" placeholder="Rechercher..." [(ngModel)]="searchQuery" (input)="applyFilters()" />
    </div>
  
    <!-- Table -->
    <table class="table table-bordered table-hover">
      <thead class="table-light">
        <tr>
          <th>Image</th>
          <th (click)="sortTable('descriptionDemandeRecyclage')" style="cursor: pointer">Description {{ getSortIcon('descriptionDemandeRecyclage') }}</th>
          <th (click)="sortTable('dateCreationDemandeRecyclage')" style="cursor: pointer">Date {{ getSortIcon('dateCreationDemandeRecyclage') }}</th>
          <th (click)="sortTable('nbrAppareils')" style="cursor: pointer">Nombre Appareils {{ getSortIcon('nbrAppareils') }}</th>
          <th (click)="sortTable('prixDemandeRecyclage')" style="cursor: pointer">Prix {{ getSortIcon('prixDemandeRecyclage') }}</th>
          <th (click)="sortTable('etatDemandeRecyclage')" style="cursor: pointer">Etat {{ getSortIcon('etatDemandeRecyclage') }}</th>

          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let demande of filteredDemandes">
          <td class="align-middle">
            <img *ngIf="demande.imageBase64" [src]="'data:image/png;base64,' + demande.imageBase64" class="img-thumbnail" style="height: 80px; width: 80px;" />
          </td>
          <td class="align-middle">{{ demande.descriptionDemandeRecyclage }}</td>
          <td class="align-middle">{{ demande.dateCreationDemandeRecyclage | date: 'shortDate' }}</td>
          <td class="align-middle">{{ demande.nbrAppareils }}</td>
          <td class="align-middle">{{ demande.prixDemandeRecyclage | currency: 'TND  ' }}</td>
          <td class="align-middle">{{  demande.etatDemandeRecyclage}}</td>

          <td class="align-middle">
            <!-- Voir â†’ Eye icon -->
            <button class="btn btn-sm btn-info me-1" (click)="viewDetails(demande)" title="Voir">
              <i class="bi bi-eye"></i>
            </button>
          
            <!-- Modifier â†’ Pencil icon -->
            <button class="btn btn-sm btn-warning me-1" (click)="edit(demande)" title="Modifier">
              <i class="bi bi-pencil"></i>
            </button>
          
            <!-- Supprimer â†’ Trash icon -->
            <button class="btn btn-sm btn-danger" (click)="delete(demande.idDemandeRecyclage)" title="Supprimer">
              <i class="bi bi-trash"></i>
            </button>
          </td>
          
        </tr>
      </tbody>
    </table>
  </div>
  
<!-- Modal -->
<div
class="modal fade"
id="staticBackdrop"
data-bs-backdrop="static"
data-bs-keyboard="false"
tabindex="-1"
aria-labelledby="staticBackdropLabel"
aria-hidden="true"
>
<div class="modal-dialog">
  <div class="modal-content">
    <form #form="ngForm" (ngSubmit)="saveOrUpdate(form)">
      <div class="modal-header">
        <h5 class="modal-title" id="staticBackdropLabel">
          {{ isEditMode ? 'Modifier' : 'Ajouter' }} une Demande
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>

      <div class="modal-body">
        <!-- âœ… Image Preview -->
        <div class="mb-3 text-center" *ngIf="demande.imageData">
          <img
            [src]="demande.imageData"
            class="img-fluid rounded"
            alt="AperÃ§u image"
            style="max-height: 150px;"
          />
        </div>

        <!-- âœ… Image Upload -->
        <div class="mb-3">
          <label for="image" class="form-label">{{ imageLabel }}</label>
          <input
            #fileInput
            id="image"
            type="file"
            (change)="onFileChange($event)"
            class="form-control"
            [required]="!isEditMode"
          />
        </div>

        <!-- âœ… Description -->
        <div class="mb-3">
          <label for="description" class="form-label">Description</label>
          <input
            id="description"
            type="text"
            [(ngModel)]="demande.descriptionDemandeRecyclage"
            name="descriptionDemandeRecyclage"
            #description="ngModel"
            class="form-control"
            required
            minlength="15"
          />
          <div
            *ngIf="description.invalid && (description.dirty || description.touched)"
            class="text-danger mt-1"
          >
            <div *ngIf="description.errors?.['required']">
              La description est obligatoire.
            </div>
            <div *ngIf="description.errors?.['minlength']">
              Minimum
              {{ description.errors?.['minlength']?.requiredLength }}
              caractÃ¨res (actuellement
              {{ description.errors?.['minlength']?.actualLength }}).
            </div>
          </div>
        </div>

        <!-- âœ… Date de crÃ©ation -->
        <div class="mb-3">
          <label for="date" class="form-label">Date de crÃ©ation</label>
          <input
            id="date"
            type="date"
            [(ngModel)]="demande.dateCreationDemandeRecyclage"
            name="dateCreationDemandeRecyclage"
            #dateField="ngModel"
            class="form-control"
            required
            [max]="today"
          />
          <div
            *ngIf="dateField.invalid && (dateField.dirty || dateField.touched)"
            class="text-danger mt-1"
          >
            <div *ngIf="dateField.errors?.['required']">
              La date est obligatoire.
            </div>
            <div *ngIf="demande.dateCreationDemandeRecyclage && demande.dateCreationDemandeRecyclage.toISOString().split('T')[0] > today">
            La date doit Ãªtre antÃ©rieure Ã  aujourdâ€™hui.
            </div>
            
          </div>
        </div>

        <!-- âœ… Nombre d'appareils -->
        <div class="mb-3">
          <label for="nbr" class="form-label">Nombre d'appareils</label>
          <input
            id="nbr"
            type="number"
            [(ngModel)]="demande.nbrAppareils"
            name="nbrAppareils"
            #nbrField="ngModel"
            class="form-control"
            required
            min="1"
          />
          <div
            *ngIf="nbrField.invalid && (nbrField.dirty || nbrField.touched)"
            class="text-danger mt-1"
          >
            <div *ngIf="nbrField.errors?.['required']">
              Le nombre est obligatoire.
            </div>
            <div *ngIf="nbrField.errors?.['min']">
              Le nombre doit Ãªtre supÃ©rieur ou Ã©gal Ã Â 1.
            </div>
          </div>
        </div>

        <!-- âœ… Prix estimÃ© -->
        <div class="mb-3">
          <label for="prix" class="form-label">Prix estimÃ©</label>
          <input
            id="prix"
            type="number"
            [(ngModel)]="demande.prixDemandeRecyclage"
            name="prixDemandeRecyclage"
            #prixField="ngModel"
            class="form-control"
            required
            min="1"
          />
          <div
            *ngIf="prixField.invalid && (prixField.dirty || prixField.touched)"
            class="text-danger mt-1"
          >
            <div *ngIf="prixField.errors?.['required']">
              Le prix est obligatoire.
            </div>
            <div *ngIf="prixField.errors?.['min']">
              Le prix doit Ãªtre supÃ©rieur ou Ã©gal Ã Â 1.
            </div>
          </div>
        </div>

<!-- âœ… Ã‰tat -->
<div class="mb-3">
  <label for="etatDemandeRecyclage" class="form-label">Ã‰tat</label>
  <select
    id="etatDemandeRecyclage"
    [(ngModel)]="demande.etatDemandeRecyclage"
    name="etatDemandeRecyclage"
    class="form-select"
    required
  >
    <option *ngFor="let etat of etatOptions" [value]="etat">{{ etat }}</option>
  </select>
</div>


      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Annuler
        </button>
        <button type="submit" class="btn btn-success">
          {{ isEditMode ? 'Mettre Ã  jour' : 'Ajouter' }}
        </button>
        
      </div>
    </form>
  </div>
</div>
</div>
<!-- Delete Confirmation Modal -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
<div class="modal-dialog">
  <div class="modal-content">
    <div class="modal-header">
      <h5 class="modal-title" id="confirmDeleteModalLabel">Confirmation</h5>
      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
    </div>
    <div class="modal-body">
      ÃŠtes-vous sÃ»r de vouloir supprimer cette demande ?
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
      <button type="button" class="btn btn-danger" (click)="confirmDelete()">Supprimer</button>
    </div>
  </div>
</div>
</div>
<!-- Details Modal -->
<div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="detailsModalLabel" aria-hidden="true">
<div class="modal-dialog modal-lg">
  <div class="modal-content">
    <div class="modal-header">
      <h5 class="modal-title" id="detailsModalLabel">DÃ©tails de la Demande</h5>
      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
    </div>
    <div class="modal-body">
      <div *ngIf="selectedDemande">
        <img *ngIf="selectedDemande.imageBase64"
        [src]="'data:image/png;base64,' + selectedDemande.imageBase64"
        class="img-fluid mb-3 detail-image"
        alt="Image de la demande" />
             <p><strong>Description:</strong> {{ selectedDemande.descriptionDemandeRecyclage }}</p>
        <p><strong>Date de crÃ©ation:</strong> {{ selectedDemande.dateCreationDemandeRecyclage | date: 'shortDate' }}</p>
        <p><strong>Nombre d'appareils:</strong> {{ selectedDemande.nbrAppareils }}</p>
        <p><strong>Prix estimÃ©:</strong> {{ selectedDemande.prixDemandeRecyclage | currency: 'EUR' }}</p>
        <p><strong>Ã‰tat:</strong> {{ selectedDemande.etatDemandeRecyclage || 'ENCOURS' }}</p>
      </div>

      <hr />
      <h5>ðŸ’¬ Commentaires</h5>
      
      <div *ngFor="let c of commentaires" class="mb-2 border-bottom pb-2 d-flex justify-content-between align-items-start">
        <div>
          <small class="text-muted">{{ c.dateCreation | date: 'short' }}</small>
          <p class="mb-1">{{ c.content }}</p>
        </div>
        <button class="btn btn-sm btn-outline-danger" (click)="deleteComment(c.idCommentaire!)" title="Supprimer le commentaire">
          ðŸ—‘
        </button>
      </div>
      
      <div class="mt-3">
        <textarea [(ngModel)]="newComment" rows="2" class="form-control" placeholder="Ajouter un commentaire..."></textarea>
        <button class="btn btn-sm btn-primary mt-2" (click)="submitComment()">Commenter</button>
      </div>
      


    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
    </div>
  </div>
</div>
</div>